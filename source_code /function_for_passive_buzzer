import RPi.GPIO as GPIO
import time

# GPIO 설정
GPIO.setmode(GPIO.BCM)

# 초음파 센서 및 부저 핀 설정
TRIGGER_LEFT = 27
ECHO_LEFT = 28
TRIGGER_MIDDLE = 10
ECHO_MIDDLE = 11
TRIGGER_RIGHT = 15
ECHO_RIGHT = 16
LEFT_BUZZER_PIN = 30
RIGHT_BUZZER_PIN = 8

# GPIO 설정
GPIO.setup(TRIGGER_LEFT, GPIO.OUT)
GPIO.setup(ECHO_LEFT, GPIO.IN)
GPIO.setup(TRIGGER_MIDDLE, GPIO.OUT)
GPIO.setup(ECHO_MIDDLE, GPIO.IN)
GPIO.setup(TRIGGER_RIGHT, GPIO.OUT)
GPIO.setup(ECHO_RIGHT, GPIO.IN)
GPIO.setup(LEFT_BUZZER_PIN, GPIO.OUT)
GPIO.setup(RIGHT_BUZZER_PIN, GPIO.OUT)

# 부저 PWM 설정
left_buzzer_pwm = GPIO.PWM(LEFT_BUZZER_PIN, 1000)
right_buzzer_pwm = GPIO.PWM(RIGHT_BUZZER_PIN, 1000)

# 함수 정의: 거리 측정
def measure_distance(trigger_pin, echo_pin):
    GPIO.output(trigger_pin, GPIO.LOW)
    time.sleep(0.00001)
    GPIO.output(trigger_pin, GPIO.HIGH)
    time.sleep(0.00001)
    GPIO.output(trigger_pin, GPIO.LOW)

    start_time = time.time()
    stop_time = time.time()

    while GPIO.input(echo_pin) == 0:
        start_time = time.time()

    while GPIO.input(echo_pin) == 1:
        stop_time = time.time()

    elapsed_time = stop_time - start_time
    distance = elapsed_time * 34000.0 / 2.0 / 1000000.0
    return distance

# 함수 정의: 부저 울리기
def play_buzzer(buzzer_pin, distance):
    if 0 < distance <= 40:
        frequency = 700
        delay_time = 0.3
    else:
        frequency = 0
        delay_time = 0

    if frequency != 0:
        GPIO.output(buzzer_pin, GPIO.HIGH)
        left_buzzer_pwm.start(50)
        time.sleep(delay_time)
        GPIO.output(buzzer_pin, GPIO.LOW)
        left_buzzer_pwm.stop()
        time.sleep(delay_time)

try:
    while True:
        # 왼쪽 초음파 센서로 거리 측정
        distance_left = measure_distance(TRIGGER_LEFT, ECHO_LEFT)
        # 부저 울리기
        play_buzzer(LEFT_BUZZER_PIN, distance_left)

        # 가운데 초음파 센서로 거리 측정
        distance_middle = measure_distance(TRIGGER_MIDDLE, ECHO_MIDDLE)
        # 왼쪽, 오른쪽 부저 울리기
        play_buzzer(LEFT_BUZZER_PIN, distance_middle)
        play_buzzer(RIGHT_BUZZER_PIN, distance_middle)

        # 오른쪽 초음파 센서로 거리 측정
        distance_right = measure_distance(TRIGGER_RIGHT, ECHO_RIGHT)
        # 부저 울리기
        play_buzzer(RIGHT_BUZZER_PIN, distance_right)

        # 측정 주기 간격
        time.sleep(1)

except KeyboardInterrupt:
    # 프로그램 종료 시 GPIO 정리
    left_buzzer_pwm.stop()
    right_buzzer_pwm.stop()
    GPIO.cleanup()
